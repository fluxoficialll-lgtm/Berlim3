import{u as B,e as W,r as o,c as A,j as e}from"./index-BC19Iu_T.js";import{p as w}from"./postService-XFLx8Vj8.js";import{r as Y}from"./recommendationService-D1Cq_qcN.js";import{F as Z}from"./FeedItem-DGLoJJDB.js";import{F as J}from"./Footer-CqKWM_In.js";import{M as K}from"./MainHeader-C_NQXNMS.js";import"./UserBadge-CHMRiDZl.js";import"./UserAvatar-BWaKHm2D.js";const Q=()=>{const i=B(),{showConfirm:j}=W(),c=o.useRef(null),[d,u]=o.useState([]),[x,C]=o.useState(!0),[N,I]=o.useState(null),[p,P]=o.useState(void 0),[h,k]=o.useState(!1),[g,y]=o.useState(!0),M=15,S=o.useRef(0),m=o.useRef(!1),[f,_]=o.useState(!1),E=o.useRef(new Set),b=o.useRef(null),R=o.useMemo(()=>A.getCurrentUser(),[]),L=R?.id,V=o.useMemo(()=>localStorage.getItem("settings_18_plus")==="true",[]),O=o.useCallback((t,s=!1)=>{t&&u(n=>{const r=s?t:[...n,...t],a=new Map;return r.forEach(l=>{l&&l.id&&!a.has(l.id)&&a.set(l.id,l)}),Array.from(a.values()).map(l=>({p:l,score:Y.scorePost(l,R?.email)})).sort((l,T)=>T.score-l.score).map(l=>l.p)})},[R?.email]),F=o.useCallback(async(t,s=!1)=>{if(!(m.current&&!s)){m.current=!0,k(!0);try{const n=localStorage.getItem("feed_location_filter"),r=n==="Global"||!n?null:n,a=await w.getFeedPaginated({limit:M,cursor:t,locationFilter:r,allowAdultContent:V}),v=(a.data||[]).filter(l=>l&&(l.type!=="video"||l.isAd));s?O(v,!0):v.length>0&&O(v,!1),P(a.nextCursor),y(!!a.nextCursor&&v.length>0)}catch(n){console.error("Feed sync error",n),y(!1)}finally{k(!1),m.current=!1}}},[V,O]);o.useEffect(()=>{if(!A.getCurrentUserEmail()){i("/");return}const s=localStorage.getItem("feed_location_filter");I(s),F(void 0,!0)},[i,F]),o.useEffect(()=>{if(d.length===0)return;const t=new IntersectionObserver(n=>{n.forEach(r=>{if(r.isIntersecting){const a=r.target.getAttribute("data-post-id");a&&!E.current.has(a)&&(E.current.add(a),w.incrementView(a))}})},{threshold:.15});return document.querySelectorAll(".feed-post-item").forEach(n=>t.observe(n)),()=>t.disconnect()},[d]),o.useEffect(()=>{const t=new IntersectionObserver(s=>{s[0].isIntersecting&&g&&!h&&!m.current&&p&&F(p)},{root:null,threshold:.1});return b.current&&t.observe(b.current),()=>t.disconnect()},[g,p,F,h]);const U=()=>{if(!c.current)return;const t=c.current.scrollTop;C(t<=S.current||t<=100),S.current=t},$=async t=>{const s=await w.toggleLike(t);s&&u(n=>n.map(r=>r.id===t?{...r,liked:s.liked,likes:s.likes}:r))},z=async(t,s)=>{t.stopPropagation(),await j("Excluir Post","Deseja excluir permanentemente?","Excluir","Cancelar")&&(await w.deletePost(s),u(n=>n.filter(r=>r.id!==s)))},D=t=>{i(`/user/${t.replace("@","")}`)},G=t=>{i(`/post/${t}`)},q=(t,s)=>{w.voteOnPoll(t,s),u(n=>n.map(r=>{if(r.id===t&&r.pollOptions&&r.votedOptionIndex==null){const a=[...r.pollOptions];return a[s].votes+=1,{...r,pollOptions:a,votedOptionIndex:s,totalVotes:(r.totalVotes||0)+1}}return r}))},H=t=>{t?.startsWith("http")?window.open(t,"_blank"):t&&i(t)};return{posts:d,uiVisible:x,activeLocationFilter:N,loading:h,hasMore:g,isMenuOpen:f,setIsMenuOpen:_,scrollContainerRef:c,loaderRef:b,currentUserId:L,handleContainerScroll:U,handlePostLike:$,handlePostDelete:z,handleUserClick:D,handleCommentClick:G,_handleShare,handleVote:q,handleCtaClick:H,navigate:i}},ae=()=>{const{posts:i,uiVisible:j,activeLocationFilter:c,loading:d,hasMore:u,isMenuOpen:x,setIsMenuOpen:C,scrollContainerRef:N,loaderRef:I,currentUserId:p,handleContainerScroll:P,handlePostLike:h,handlePostDelete:k,handleUserClick:g,handleCommentClick:y,handleShare:M,handleVote:S,handleCtaClick:m,navigate:f}=Q();return e.jsxs("div",{className:"h-screen bg-[radial-gradient(circle_at_top_left,_#0c0f14,_#0a0c10)] text-white font-['Inter'] flex flex-col overflow-hidden relative",children:[e.jsx(K,{leftContent:e.jsxs("button",{onClick:()=>f("/location-filter"),className:"bg-none border-none text-[#00c2ff] text-lg cursor-pointer hover:text-white flex items-center gap-1",children:[e.jsx("i",{className:`fa-solid ${c&&c!=="Global"?"fa-location-dot":"fa-globe"}`}),c&&c!=="Global"&&e.jsxs("span",{className:"text-[10px] font-black uppercase tracking-tight ml-1",children:[c.substring(0,8),".."]})]}),rightContent:e.jsx("button",{onClick:()=>f("/marketplace"),className:"bg-none border-none text-[#00c2ff] text-lg cursor-pointer hover:text-white",children:e.jsx("i",{className:"fa-solid fa-cart-shopping"})}),onLogoClick:()=>N.current?.scrollTo({top:0,behavior:"smooth"})}),e.jsxs("div",{className:"fixed top-[85px] left-1/2 -translate-x-1/2 z-40 flex items-center p-1 bg-[#1a1e26]/80 backdrop-blur-xl border border-white/10 rounded-full shadow-[0_4px_20px_rgba(0,0,0,0.5)]",children:[e.jsx("button",{className:"px-6 py-2 rounded-full bg-[#00c2ff] text-[#0c0f14] text-sm font-bold shadow-[0_0_15px_rgba(0,194,255,0.4)]",children:"Feed"}),e.jsx("button",{className:"px-6 py-2 rounded-full text-gray-400 text-sm font-medium hover:text-white",onClick:()=>f("/reels"),children:"Reels"})]}),e.jsx("main",{ref:N,onScroll:P,className:"flex-grow w-full overflow-y-auto overflow-x-hidden relative pt-[140px] no-scrollbar",children:e.jsxs("div",{className:"w-full max-w-[500px] mx-auto pb-[100px] px-3",children:[d&&i.length===0&&e.jsx("div",{className:"w-full flex justify-center mt-20",children:e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin text-2xl text-[#00c2ff]"})}),!d&&i.length===0&&e.jsxs("div",{className:"text-center text-gray-500 mt-20 animate-fade-in",children:[e.jsx("i",{className:"fa-solid fa-ghost text-4xl opacity-30 mb-3"}),e.jsx("p",{className:"font-bold uppercase tracking-widest text-xs",children:"Nada por aqui ainda."})]}),i.length>0&&i.map(_=>e.jsx(Z,{post:_,currentUserId:p,onLike:h,onDelete:(E,b)=>k(E,b),onUserClick:g,onCommentClick:y,onShare:M,onVote:S,onCtaClick:m},_.id)),e.jsxs("div",{ref:I,className:"w-full h-24 flex items-center justify-center py-6",children:[d&&i.length>0&&e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin text-2xl text-[#00c2ff]"}),!d&&!u&&i.length>0&&e.jsx("div",{className:"text-gray-500 text-sm font-medium opacity-60",children:"• Fim do Feed •"})]})]})}),x&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-40 backdrop-blur-sm",onClick:()=>C(!1)}),e.jsxs("div",{className:`fixed bottom-[180px] right-[27px] flex flex-col gap-4 z-50 items-end transition-all duration-300 ${x?"opacity-100 translate-y-0":"opacity-0 translate-y-10 pointer-events-none"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>f("/feed-search"),children:[e.jsx("span",{className:"text-white font-medium text-sm bg-[#1a1e26] px-3 py-1.5 rounded-lg border border-white/10",children:"Buscar"}),e.jsx("div",{className:"w-[50px] h-[50px] rounded-full bg-[#1a1e26] border border-white/10 flex items-center justify-center text-[#00c2ff] shadow-lg",children:e.jsx("i",{className:"fa-solid fa-magnifying-glass"})})]}),e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>f("/create-reel"),children:[e.jsx("span",{className:"text-white font-medium text-sm bg-[#1a1e26] px-3 py-1.5 rounded-lg border border-white/10",children:"Criar Reel"}),e.jsx("div",{className:"w-[50px] h-[50px] rounded-full bg-gradient-to-tr from-[#f9ce34] via-[#ee2a7b] to-[#6228d7] flex items-center justify-center text-white shadow-lg",children:e.jsx("i",{className:"fa-solid fa-clapperboard"})})]}),e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>f("/create-post"),children:[e.jsx("span",{className:"text-white font-medium text-sm bg-[#1a1e26] px-3 py-1.5 rounded-lg border border-white/10",children:"Novo Post"}),e.jsx("div",{className:"w-[50px] h-[50px] rounded-full bg-gradient-to-tr from-[#00c2ff] to-[#007bff] flex items-center justify-center text-white shadow-lg",children:e.jsx("i",{className:"fa-solid fa-pen"})})]})]}),e.jsx("button",{onClick:()=>C(!x),className:`fixed bottom-[105px] right-[20px] w-[60px] h-[60px] bg-[#00c2ff] rounded-full text-white text-[24px] cursor-pointer shadow-[0_4px_15px_rgba(0,194,255,0.4)] z-50 flex items-center justify-center transition-all duration-300 ${j?"scale-100":"scale-0"} ${x?"rotate-45 bg-[#ff4d4d]":""}`,children:e.jsx("i",{className:"fa-solid fa-plus"})}),e.jsx(J,{visible:j})]})};export{ae as Feed};

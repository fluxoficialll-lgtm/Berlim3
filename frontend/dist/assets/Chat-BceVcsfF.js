import{u as e,f as t,e as s,r as l,c as a,k as n,i as o,z as i,j as c}from"./index-CipjSFYz.js";import{C as r,Y as d,M as u,a as f}from"./MessageItem-C7dPClsw.js";const m=({isOpen:e,onClose:t,onSearch:s,onSelect:l,onBlock:a,onClear:n,isBlocked:o})=>{if(!e)return null;const i=[{label:"Pesquisar",icon:"fa-solid fa-magnifying-glass",onClick:s},{label:"Selecionar",icon:"fa-solid fa-check-double",onClick:l},{label:o?"Desbloquear":"Bloquear",icon:"fa-solid fa-ban",onClick:a},{label:"Limpar conversa",icon:"fa-solid fa-trash-can",onClick:n,isDestructive:!0}];return c.jsx("div",{className:"fixed inset-0 z-[100] bg-transparent",onClick:t,children:c.jsx("div",{className:"absolute top-[70px] right-4 w-[220px] bg-[#1a1e26] rounded-2xl p-2 shadow-2xl animate-pop-in border border-white/10",onClick:e=>e.stopPropagation(),children:c.jsx("div",{className:"flex flex-col gap-1",children:i.map((e,s)=>c.jsxs("button",{onClick:()=>{e.onClick(),t()},className:"w-full flex items-center gap-3 p-3 rounded-xl transition-all active:scale-[0.98] "+(e.isDestructive?"hover:bg-red-500/10 text-red-400":"hover:bg-white/5 text-white"),children:[c.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 "+(e.isDestructive?"bg-red-500/20":"bg-[#00c2ff1a]"),children:c.jsx("i",{className:`${e.icon} ${e.isDestructive?"text-red-400":"text-[#00c2ff]"} text-xs`})}),c.jsx("span",{className:"font-bold text-xs",children:e.label})]},s))})})})},g=()=>{const{navigate:g,contactName:p,contactHandle:h,contactAvatar:S,contactStatus:x,isBlocked:v,virtuosoRef:b,isSelectionMode:C,setIsSelectionMode:M,selectedIds:k,setSelectedIds:w,isSearchOpen:j,setIsSearchOpen:y,searchTerm:I,setSearchTerm:O,playingAudioId:B,zoomedMedia:N,setZoomedMedia:D,isMenuModalOpen:T,setIsMenuModalOpen:A,currentUserEmail:E,handleSendMessage:L,handleToggleSelection:U,handleStartSelection:_,handleDeleteSelected:z,filteredMessages:$}=(()=>{var c;const r=e(),{id:d}=t(),{showConfirm:u,showOptions:f}=s(),m=d||"1",[g,p]=l.useState([]),[h,S]=l.useState(""),[x,v]=l.useState(""),[b,C]=l.useState(void 0),[M,k]=l.useState("Offline"),[w,j]=l.useState(!1),y=l.useRef(null),[I,O]=l.useState(!1),[B,N]=l.useState([]),[D,T]=l.useState(!1),[A,E]=l.useState(""),[L,U]=l.useState(null),[_,z]=l.useState(null),[$,q]=l.useState(!1),P=null==(c=a.getCurrentUserEmail())?void 0:c.toLowerCase(),R=l.useCallback((e=!1)=>{var t,s,l,a,i;const c=n.getChat(m);if(!c)return void r("/messages");let d;j(c.isBlocked);let u,f=c.contactName,g="";if(m.includes("_")&&m.includes("@")&&P){const e=m.split("_").find(e=>e.toLowerCase()!==P);if(e){const n=Object.values(o.users.getAll()).find(t=>t.email.toLowerCase()===e.toLowerCase());n?(d=n,f=(null==(t=n.profile)?void 0:t.nickname)||(null==(s=n.profile)?void 0:s.name)||`@${null==(l=n.profile)?void 0:l.name}`,u=null==(a=n.profile)?void 0:a.photoUrl,g=(null==(i=n.profile)?void 0:i.name)||""):f=e.split("@")[0]}}if(S(f),C(u),v(g),null==d?void 0:d.lastSeen){const e=Date.now()-d.lastSeen;k(e<12e4?"Online":"Offline")}else k("Offline");const h=c.messages||[],x=new Map;h.forEach(e=>{(e.deletedBy||[]).includes(P||"")||x.set(e.id,e)});const b=Array.from(x.values()).sort((e,t)=>e.id-t.id);p(b)},[m,P,r]);l.useEffect(()=>{R();const e=i.on("chat_deleted_globally",e=>{e.chatId===m&&r("/messages",{replace:!0})}),t=i.on("messages_deleted_globally",e=>{e.chatId===m&&R(!0)}),s=o.subscribe("chats",()=>R(!0));return()=>{e(),t(),s()}},[m,R,r]);const H=l.useMemo(()=>g.filter(e=>(e.text||"").toLowerCase().includes(A.toLowerCase())),[g,A]);return{navigate:r,chatId:m,messages:g,contactName:h,contactHandle:x,contactAvatar:b,contactStatus:M,isBlocked:w,virtuosoRef:y,isSelectionMode:I,setIsSelectionMode:O,selectedIds:B,setSelectedIds:N,isSearchOpen:D,setIsSearchOpen:T,searchTerm:A,setSearchTerm:E,playingAudioId:L,zoomedMedia:_,setZoomedMedia:z,isMenuModalOpen:$,setIsMenuModalOpen:q,currentUserEmail:P,handleSendMessage:e=>{var t,s,l;const o=a.getCurrentUser(),i={id:Date.now(),text:e,type:"sent",contentType:"text",timestamp:(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),status:"sent",senderEmail:null==o?void 0:o.email,senderAvatar:null==(t=null==o?void 0:o.profile)?void 0:t.photoUrl,senderName:(null==(s=null==o?void 0:o.profile)?void 0:s.nickname)||(null==(l=null==o?void 0:o.profile)?void 0:l.name)||"VocÃª",deletedBy:[]};n.sendMessage(m,i)},handleToggleSelection:e=>{N(t=>{const s=t.includes(e)?t.filter(t=>t!==e):[...t,e];return 0===s.length&&O(!1),s})},handleStartSelection:e=>{O(!0),N([e]),navigator.vibrate&&navigator.vibrate(10)},handleDeleteSelected:async()=>{if(0===B.length)return;const e=await f("Excluir Mensagem",[{label:"Excluir para mim",value:"me",icon:"fa-solid fa-user"},{label:"Excluir para todos",value:"all",icon:"fa-solid fa-users",isDestructive:!0}]);e&&(await n.deleteMessages(m,B,e),O(!1),N([]),R(!0))},filteredMessages:H}})();return c.jsxs("div",{className:"messages-page h-[100dvh] flex flex-col overflow-hidden",style:{background:"radial-gradient(circle at top left, #0c0f14, #0a0c10)",color:"#fff"},children:[c.jsx(r,{title:p,subtitle:v?"Bloqueado":x,avatar:S,onBack:()=>g("/messages"),onInfoClick:()=>h&&g(`/user/${h}`),isSelectionMode:C,selectedCount:k.length,onCancelSelection:()=>{M(!1),w([])},onDeleteSelection:z,isSearchOpen:j,onToggleSearch:()=>{y(!j),O("")},searchTerm:I,onSearchChange:O,onMenuClick:()=>A(!0)}),c.jsx("main",{style:{flexGrow:1,width:"100%",display:"flex",flexDirection:"column",paddingTop:"60px"},children:c.jsx(d,{ref:b,style:{height:"100%",paddingBottom:"80px"},data:$,initialTopMostItemIndex:$.length-1,followOutput:"smooth",itemContent:(e,t)=>{var s;return c.jsx(u,{msg:t,isMe:(null==(s=t.senderEmail)?void 0:s.toLowerCase())===E,isSelectionMode:C,isSelected:k.includes(t.id),onSelect:U,onStartSelection:_,onMediaClick:(e,t)=>D({url:e,type:t}),onProductClick:e=>g(`/marketplace/product/${e}`),playingAudioId:B,onPlayAudio:()=>{}},t.id)}})}),!C&&c.jsx(f,{onSendMessage:L,onSendAudio:()=>{},onFileSelect:()=>{},isBlocked:v,isUploading:!1}),c.jsx(m,{isOpen:T,onClose:()=>A(!1),isBlocked:v,onSearch:()=>y(!0),onSelect:()=>M(!0),onBlock:()=>{},onClear:()=>{}}),N&&c.jsx("div",{className:"fixed inset-0 z-[60] bg-black bg-opacity-95 flex items-center justify-center p-2",onClick:()=>D(null),children:c.jsx("img",{src:N.url,className:"max-w-full max-h-full object-contain"})})]})};export{g as Chat};

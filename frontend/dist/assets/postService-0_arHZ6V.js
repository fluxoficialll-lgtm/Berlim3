import{c as e,A as t,i as s}from"./index-CipjSFYz.js";const i={formatRelativeTime:e=>{const t=Math.floor((Date.now()-e)/1e3);return t<60?"Agora":t<3600?`${Math.floor(t/60)}m`:t<86400?`${Math.floor(t/3600)}h`:new Date(e).toLocaleDateString()},sanitizePost:t=>{const s=e.getCurrentUserId(),i=Array.isArray(t.likedByIds)?t.likedByIds:[];return{...t,id:String(t.id),text:String(t.text||""),authorId:String(t.authorId||""),username:String(t.username||"AnÃ´nimo"),likes:Number(t.likes||0),comments:Number(t.comments||0),views:Number(t.views||0),liked:s?i.includes(s):!!t.liked,images:t.images||void 0,isAd:!!t.isAd,ctaText:t.ctaText||void 0,ctaLink:t.ctaLink||void 0,relatedGroupId:t.relatedGroupId||void 0,isAdultContent:!!t.isAdultContent,location:t.location||void 0}}},n=`${t}/api/posts`,o={async getFeedPaginated(e){try{const t=new AbortController,s=setTimeout(()=>t.abort(),8e3),o=await fetch(`${n}?limit=${e.limit}&cursor=${e.cursor||""}`,{signal:t.signal});if(clearTimeout(s),!o.ok)return{data:[],nextCursor:void 0};const a=await o.json();return{data:(a.data||[]).map(i.sanitizePost),nextCursor:a.nextCursor}}catch(t){return{data:[],nextCursor:void 0}}},async searchPosts(e){if(!e.trim())return[];try{const t=await fetch(`${n}/search?q=${encodeURIComponent(e)}`);if(t.ok){return((await t.json()).data||[]).map(i.sanitizePost)}return[]}catch(t){return[]}},async getPostById(e){try{const t=await fetch(`${n}/${e}`);if(!t.ok)return;const s=await t.json();return s?i.sanitizePost(s):void 0}catch(t){return}},async getUserPosts(e){try{const t=await fetch(`${n}/user/${e}`);if(!t.ok)return[];return((await t.json()).data||[]).map(i.sanitizePost)}catch(t){return[]}}},a="flux_viewed_posts_session",r={trackView:async i=>{let n=[];try{n=JSON.parse(sessionStorage.getItem(a)||"[]")}catch(d){n=[]}if(n.includes(i))return;const o=s.posts.findById(i);if(!o)return;n.push(i),sessionStorage.setItem(a,JSON.stringify(n));const r=e.getCurrentUserId();o.views=(o.views||0)+1,s.posts.update(o);try{fetch(`${t}/api/posts/${i}/interact`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:r,type:"view",action:"add"})}).catch(()=>{})}catch(d){}},toggleLike:async(i,n)=>{const o=s.posts.findById(i);if(!o)return null;const a=e.getCurrentUserId(),r=n?"remove":"add";if(o.liked=!n,o.likes=Math.max(0,(o.likes||0)+(o.liked?1:-1)),a){const e=new Set(o.likedByIds||[]);o.liked?e.add(a):e.delete(a),o.likedByIds=Array.from(e)}s.posts.update(o);try{fetch(`${t}/api/posts/${i}/interact`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a,type:"like",action:r})}).catch(()=>{})}catch(d){}return o},notifyCommentChange:(e,t)=>{const i=s.posts.findById(e);i&&(i.comments=Math.max(0,(i.comments||0)+t),s.posts.update(i))},syncPostObject:e=>{const t=s.posts.findById(e.id);return t?{...e,likes:t.likes,comments:t.comments,views:t.views,liked:t.liked}:e}},d={async toggleLike(e){const t=s.posts.findById(e);if(t)return await r.toggleLike(e,!!t.liked)||void 0},incrementView(e){r.trackView(e)},incrementShare(e){s.posts.findById(e)&&r.trackView(e)}},c=`${t}/api/posts`,m={async addComment(t,i,n,o){const a=e.getCurrentUserId(),d=n.replace(/^@/,""),m={id:Date.now().toString(),userId:a||"user",text:i,username:d,avatar:o,timestamp:Date.now(),replies:[]},l=s.posts.findById(t);if(l){l.commentsList=[m,...l.commentsList||[]],r.notifyCommentChange(t,1),s.posts.update(l);try{fetch(`${c}/${t}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:m})}).catch(()=>{})}catch(p){}return m}},addReply(t,i,n,o,a){var d;const m=s.posts.findById(t),l=e.getCurrentUserId();if(m&&m.commentsList){let e,u;for(const t of m.commentsList){if(t.id===i){e=t,u=t.username;break}const s=null==(d=t.replies)?void 0:d.find(e=>e.id===i);if(s){e=t,u=s.username;break}}if(e){const i={id:"r-"+Date.now(),userId:l||"user",text:n,username:o.replace(/^@/,""),avatar:a,timestamp:Date.now(),replies:[],replyToUsername:null==u?void 0:u.replace(/^@/,"")};e.replies=[...e.replies||[],i],r.notifyCommentChange(t,1),s.posts.update(m);try{fetch(`${c}/${t}/reply`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({parentId:e.id,reply:i})}).catch(()=>{})}catch(p){}return i}}},async deleteComment(e,t){const i=s.posts.findById(e);if(i){const n=e=>e.filter(e=>e.id!==t&&(e.replies&&(e.replies=n(e.replies)),!0));return i.commentsList=n(i.commentsList||[]),r.notifyCommentChange(e,-1),s.posts.update(i),!0}return!1},toggleCommentLike(e,t){const i=s.posts.findById(e);if(i&&i.commentsList){const e=s=>{for(const i of s){if(i.id===t)return i.likedByMe=!i.likedByMe,i.likes=(i.likes||0)+(i.likedByMe?1:-1),!0;if(i.replies&&e(i.replies))return!0}return!1};if(e(i.commentsList))return s.posts.update(i),!0}return!1}},l=`${t}/api/posts`,p={async uploadMedia(e,s="feed"){const i=new FormData;i.append("file",e),i.append("folder",s);const n=await fetch(`${t}/api/upload`,{method:"POST",body:i});return(await n.json()).files[0].url},async addPost(e){try{const t=await fetch(`${l}/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const s=await t.json();s.post&&(e=s.post)}}catch(t){}s.posts.add(i.sanitizePost(e))},async deletePost(e){s.posts.delete(e);try{await fetch(`${l}/${e}`,{method:"DELETE"})}catch(t){}}},u={formatRelativeTime:i.formatRelativeTime,sanitizePost:i.sanitizePost,getFeedPaginated:o.getFeedPaginated,searchPosts:o.searchPosts,getPostById:o.getPostById,getUserPosts:o.getUserPosts,toggleLike:d.toggleLike,incrementView:d.incrementView,incrementShare:d.incrementShare,addComment:m.addComment,addReply:m.addReply,deleteComment:m.deleteComment,toggleCommentLike:m.toggleCommentLike,addPost:p.addPost,deletePost:p.deletePost,uploadMedia:p.uploadMedia};export{r as P,u as p};

import{r as u,f as $,a as D,c as j,e as A,u as L,j as e,g as U}from"./index-BC19Iu_T.js";import{r as N}from"./reelsService-v3uh_RdW.js";import{p as S}from"./postService-XFLx8Vj8.js";import{U as z,A as B}from"./UserBadge-CHMRiDZl.js";import{C as M}from"./CommentSheet-Bk6VXXoJ.js";import{r as F}from"./recommendationService-D1Cq_qcN.js";import{a as I}from"./apiClient-cuuPgksg.js";import"./UserAvatar-BWaKHm2D.js";import"./CommentItem-BgB3JV1X.js";const V=(t,a)=>{u.useEffect(()=>{const n=db.subscribe(t,a);return()=>{n()}},[t,a,db])},W=()=>{const{id:t}=$(),n=D().state,[h,x]=u.useState([]),c=u.useCallback(async()=>{try{const i=j.getCurrentUserEmail(),s=localStorage.getItem("settings_18_plus")==="true";let d=[];if(n?.authorId)d=N.getReelsByAuthor(n.authorId,s);else if(d=N.getReels(i||void 0,s),t&&!d.find(r=>r.id===t)){const r=S.getPostById(t);r&&r.type==="video"&&(d=[r,...d])}x(d)}catch(i){console.error("Failed to load reels.",i)}},[t,n?.authorId]);u.useEffect(()=>{(async()=>{try{await N.fetchReels(),c()}catch(s){console.error("Failed to fetch initial reels.",s)}})()},[c]);const o=u.useCallback(()=>{x(i=>{let s=!1;const d=i.map(r=>{const f=db.posts.findById(r.id);return f&&(f.likes!==r.likes||f.comments!==r.comments||f.views!==r.views||f.liked!==r.liked)?(s=!0,{...r,...f}):r});return s?d:i})},[x]);return V("posts",o),{reels:h,setReels:x}},O=t=>{const{showConfirm:a}=A();return{handleLike:async c=>{t(o=>o.map(i=>{if(i.id===c){const s=!i.liked,d=i.likes+(s?1:-1);return{...i,liked:s,likes:d}}return i})),await N.toggleLike(c)},handleDeleteReel:async c=>{await a("Excluir Reel","Tem certeza que deseja excluir este reel? A a칞칚o n칚o pode ser desfeita.","Excluir","Cancelar")&&(await S.deletePost(c),t(i=>i.filter(s=>s.id!==c)))},handleShare:async c=>{const o=`${window.location.origin}/#/post/${c.id}`;if(navigator.share)try{await navigator.share({title:"Confira este Reel!",url:o}),S.incrementShare(c.id)}catch{}else navigator.clipboard.writeText(o),alert("Link copiado!"),S.incrementShare(c.id)}}},_=(t,a)=>{const[n,h]=u.useState(0),x=u.useRef(new Set),c=u.useRef(0),o=i=>{const s=j.getCurrentUserEmail();!i||!c.current||!s||((Date.now()-c.current)/1e3,t.find(d=>d.id===i),c.current=Date.now())};return u.useEffect(()=>{const i=a.current;if(!i||t.length===0)return;const s=new IntersectionObserver(r=>{r.forEach(f=>{if(f.isIntersecting){const v=Number(f.target.getAttribute("data-index"));h(v);const l=t[v];l&&!x.current.has(l.id)&&(x.current.add(l.id),N.incrementView(l.id)),c.current=Date.now()}})},{threshold:.6});return i.querySelectorAll(".reel-container-wrapper").forEach(r=>s.observe(r)),()=>s.disconnect()},[t,a]),{activeReelIndex:n,reportWatchTime:o}},G=()=>{const t=L(),{reels:a,setReels:n}=W(),h=u.useRef(null),{activeReelIndex:x,reportWatchTime:c}=_(a,h),{handleLike:o,handleDeleteReel:i,handleShare:s}=O(n),[d,r]=u.useState(new Set);return{navigate:t,containerRef:h,reels:a,activeReelIndex:x,expandedReels:d,toggleReadMore:(l,g)=>{g.stopPropagation(),r(p=>{const m=new Set(p);return m.has(l)?m.delete(l):m.add(l),m})},handleLike:o,handleDeleteReel:i,handleShare:s,reportWatchTime:c,handleCtaClick:l=>{l?.startsWith("http")?window.open(l,"_blank"):l&&t(l)}}},H=({reel:t,isActive:a,reportWatchTime:n,onVideoClick:h,isMuted:x,onToggleMute:c})=>{const o=u.useRef(null),[i,s]=u.useState(!1),[d,r]=u.useState(!0),[f,v]=u.useState(!1),g=(p=>p?p.startsWith("http")||p.startsWith("data:")||p.startsWith("blob:")?p:`${window.location.origin}${p.startsWith("/")?"":"/"}${p}`:"")(t.video);return u.useEffect(()=>{let p=!0;if(a){if(o.current&&!f&&g){const m=o.current.play();m!==void 0&&m.then(()=>{p&&(s(!0),n(t.id))}).catch(y=>{p&&(y.name==="NotAllowedError"?(s(!1),o.current&&(o.current.muted=!0,o.current.play().catch(C=>{}))):y.name!=="AbortError"&&s(!1))})}}else o.current&&(o.current.pause(),p&&s(!1),!o.current.paused&&!Number.isNaN(o.current.duration)&&(o.current.currentTime=0));return()=>{p=!1}},[a,f,g,t.id,n]),e.jsxs("div",{className:"reel-video-container w-full h-full relative",onClick:h,children:[a&&d&&!f&&g&&e.jsx("div",{className:"absolute z-10 flex items-center justify-center pointer-events-none",style:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin text-4xl text-white/80"})}),!i&&!d&&!f&&g&&e.jsx("div",{className:"absolute z-10 pointer-events-none bg-black/30 rounded-full p-4 backdrop-blur-sm",style:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:e.jsx("i",{className:"fa-solid fa-play text-4xl text-white/90 pl-1"})}),g&&!f?e.jsx("video",{ref:o,src:g,loop:!0,muted:x,playsInline:!0,"webkit-playsinline":"true",preload:"auto",className:"reel-video",onWaiting:()=>r(!0),onPlaying:()=>r(!1),onLoadedData:()=>r(!1),onError:()=>{g&&(v(!0),r(!1))}}):t.image?e.jsx("img",{src:t.image,alt:"Reel Content",className:"reel-video object-cover"}):e.jsxs("div",{className:"video-error",children:[e.jsx("i",{className:"fa-solid fa-triangle-exclamation"}),e.jsx("p",{children:"Conte칰do indispon칤vel"}),e.jsxs("button",{onClick:p=>{p.stopPropagation(),v(!1),r(!0)},className:"retry-btn",children:[e.jsx("i",{className:"fa-solid fa-rotate-right"})," Recarregar"]})]})]})},q=({reel:t,isOwner:a,isMuted:n,onLike:h,onComment:x,onShare:c,onDelete:o,onToggleMute:i})=>e.jsxs("div",{className:"reel-actions",children:[e.jsxs("button",{onClick:s=>{s.stopPropagation(),h()},children:[e.jsx("i",{className:`fa-solid fa-heart ${t.liked?"liked-heart":""}`}),e.jsx("span",{children:t.likes})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),x()},children:[e.jsx("i",{className:"fa-solid fa-comment-dots"}),e.jsx("span",{children:t.comments})]}),e.jsx("button",{onClick:s=>{s.stopPropagation(),c()},children:e.jsx("i",{className:"fa-solid fa-share"})}),a&&e.jsx("button",{onClick:s=>{s.stopPropagation(),o()},style:{color:"#ff4d4d"},children:e.jsx("i",{className:"fa-solid fa-trash"})}),e.jsx("button",{onClick:i,children:e.jsx("i",{className:`fa-solid ${n?"fa-volume-xmark":"fa-volume-high"}`})})]}),J={conferir:"fa-eye",participar:"fa-user-group",comprar:"fa-cart-shopping",assinar:"fa-credit-card",entrar:"fa-arrow-right-to-bracket",descubra:"fa-compass",baixar:"fa-download","saiba mais":"fa-circle-info"},X=({reel:t,displayName:a,avatar:n,onUserClick:h,onGroupClick:x,onCtaClick:c,isExpanded:o,onToggleExpand:i})=>{const[s,d]=u.useState(null),[r,f]=u.useState(!1);u.useEffect(()=>{if(t.relatedGroupId){const g=U.getGroupById(t.relatedGroupId);d(g||null)}else d(null)},[t.relatedGroupId]);const v=(g="")=>{const p=g.toLowerCase();return J[p]||"fa-arrow-right"},l=g=>{g.stopPropagation(),n?f(!0):h()};return e.jsxs("div",{className:"reel-desc-overlay",children:[t.isAd&&t.ctaLink?e.jsxs("button",{className:"bg-[#00c2ff] text-black border-none px-5 py-3 rounded-xl text-xs font-black flex items-center justify-between w-full mt-3 shadow-[0_4px_15px_rgba(0,194,255,0.3)] active:scale-95",onClick:()=>c(t.ctaLink),style:{pointerEvents:"auto"},children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("i",{className:`fa-solid ${v(t.ctaText)}`}),e.jsx("span",{className:"uppercase tracking-wider",children:t.ctaText||"Saiba Mais"})]}),e.jsx("i",{className:"fa-solid fa-chevron-right opacity-50"})]}):s&&e.jsxs("button",{className:"reel-group-btn",onClick:()=>x(s.id,s),style:s.isVip?{background:"linear-gradient(90deg, #FFD700, #B8860B)",color:"#000",border:"none",fontWeight:"800"}:{background:"rgba(255, 255, 255, 0.15)",color:"#fff",border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx("i",{className:`fa-solid ${s.isVip?"fa-crown":"fa-users"}`,style:{color:s.isVip?"#000":"inherit"}}),e.jsx("span",{className:"truncate max-w-[150px]",children:s.isVip?`VIP: ${s.name}`:s.name}),e.jsx("i",{className:"fa-solid fa-chevron-right",style:{fontSize:"10px"}})]}),e.jsxs("div",{className:"reel-username",children:[e.jsx(z,{avatarUrl:n,nickname:a,handle:t.username,isVip:t.isAd,avatarSize:"sm",showHandle:!1,onAvatarClick:l,onNameClick:h}),t.isAdultContent&&e.jsx("span",{className:"adult-badge",children:"18+"}),t.isAd&&e.jsx("span",{className:"sponsored-badge",children:"Patrocinado"})]}),e.jsx("div",{className:"reel-title mt-1",children:o?t.text:e.jsxs(e.Fragment,{children:[t.text.slice(0,60),t.text.length>60&&e.jsx("span",{className:"reel-read-more",onClick:i,children:"mais"})]})}),e.jsxs("div",{style:{fontSize:"12px",color:"#aaa",marginTop:"10px",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx("i",{className:"fa-solid fa-play"})," ",t.views," visualiza칞칫es"]}),e.jsx(B,{isOpen:r,onClose:()=>f(!1),imageSrc:n||"",username:a})]})},K=({reel:t,isActive:a,isOwner:n,onLike:h,onComment:x,onShare:c,onDelete:o,onUserClick:i,getDisplayName:s,getUserAvatar:d,isExpanded:r,onToggleExpand:f,reportWatchTime:v,onCtaClick:l,onGroupClick:g})=>{const[p,m]=u.useState(!1),y=C=>{C.stopPropagation(),m(!p)};return e.jsxs("div",{className:"reel",children:[e.jsx(H,{reel:t,isActive:a,reportWatchTime:v,isMuted:p,onToggleMute:y,onVideoClick:()=>{}}),e.jsx(q,{reel:t,isOwner:n,isMuted:p,onLike:h,onComment:x,onShare:c,onDelete:o,onToggleMute:y}),e.jsx(X,{reel:t,displayName:s(t.username),avatar:d(t.username),onUserClick:i,onGroupClick:g,onCtaClick:l,isExpanded:r,onToggleExpand:f})]})},P={async getComments(t){try{return(await I.get(`/reels/${t}/comments`)).data}catch(a){throw console.error(`[ReelsCommentService] Erro ao buscar coment치rios para o Reel ${t}:`,a),a}},async addComment(t,a){try{return(await I.post(`/reels/${t}/comments`,{content:a})).data}catch(n){throw console.error(`[ReelsCommentService] Erro ao adicionar coment치rio ao Reel ${t}:`,n),n}},async deleteComment(t){try{await I.delete(`/comments/${t}`)}catch(a){throw console.error(`[ReelsCommentService] Erro ao deletar o coment치rio ${t}:`,a),a}}},Q=({reel:t,isOpen:a,onClose:n})=>{const{showConfirm:h}=A(),x=L(),[c,o]=u.useState([]),[i,s]=u.useState(!1),[d,r]=u.useState(""),[f,v]=u.useState(null),l=t?.id,p=j.getCurrentUser()?.id,m=u.useCallback(async b=>{if(b){s(!0);try{const w=await P.getComments(b);o(w)}catch(w){console.error("Falha ao carregar coment치rios do Reel:",w),o([])}finally{s(!1)}}},[]);u.useEffect(()=>{a&&l?m(l):(o([]),r(""),v(null))},[a,l,m]);const y=async()=>{if(!l||!d.trim())return;const b=j.getCurrentUser();if(b)if(f){const w=b.profile?.name||"user",k=b.profile?.photoUrl;S.addReply(l,f.id,d.trim(),w,k)&&(v(null),r(""),m(l))}else try{await P.addComment(l,d.trim()),r(""),await m(l),b.email&&t&&F.recordInteraction(b.email,t,"comment")}catch(w){console.error("Falha ao enviar coment치rio no Reel:",w)}},C=async b=>{if(l&&await h("Excluir coment치rio","Deseja excluir este coment치rio?","Excluir","Cancelar"))try{await P.deleteComment(b),await m(l)}catch(w){console.error("Falha ao deletar coment치rio do Reel:",w)}},E=b=>{l&&(S.toggleCommentLike(l,b),o(w=>w.map(k=>k.id===b?{...k,isLiked:!k.isLiked,likes:k.isLiked?k.likes-1:k.likes+1}:k)))},T=b=>{x(`/user/${b.replace("@","")}`),n()};return e.jsx(M,{isOpen:a,onClose:n,title:`Coment치rios (${c.length})`,comments:c,commentText:d,onCommentTextChange:r,onSend:y,onLike:E,onDelete:C,onUserClick:T,currentUserId:p,replyingTo:f,onCancelReply:()=>v(null),onReplyClick:(b,w)=>v({id:b,username:w})})};class Y extends u.Component{constructor(a){super(a),this.state={hasError:!1}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,n){console.error("ReelsErrorBoundary pegou um erro:",a,n),fetch("/api/errors/log-reels-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{message:a.message,stack:a.stack},errorInfo:{componentStack:n.componentStack}})}).catch(h=>console.error("Falha ao enviar log de erro para o servidor:",h))}render(){return this.state.hasError?e.jsxs("div",{style:R.container,children:[e.jsx("div",{style:R.icon,children:"游꿟游눤"}),e.jsx("h1",{style:R.title,children:"Ocorreu um Erro nos Reels"}),e.jsx("p",{style:R.message,children:"Um problema inesperado aconteceu. Nossa equipe j치 foi notificada."}),e.jsx("p",{style:R.details,children:"Detalhes do erro foram registrados para an치lise."}),e.jsx("button",{style:R.button,onClick:()=>window.location.reload(),children:"Tentar Novamente"})]}):this.props.children}}const R={container:{width:"100%",height:"100dvh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",background:"#000",color:"#fff",fontFamily:"Inter, sans-serif",padding:"20px",textAlign:"center",boxSizing:"border-box"},icon:{fontSize:"48px",marginBottom:"20px"},title:{fontSize:"24px",fontWeight:"bold",color:"#ff4d4d",marginBottom:"10px"},message:{fontSize:"16px",color:"#ccc",maxWidth:"400px",lineHeight:1.5},details:{fontSize:"12px",color:"#888",marginTop:"20px"},button:{marginTop:"30px",padding:"12px 25px",background:"#00c2ff",color:"#000",border:"none",borderRadius:"25px",fontWeight:"bold",cursor:"pointer",transition:"transform 0.2s, box-shadow 0.2s",boxShadow:"0 4px 15px rgba(0, 194, 255, 0.3)"}},ce=()=>{const{navigate:t,containerRef:a,reels:n,activeReelIndex:h,expandedReels:x,toggleReadMore:c,handleLike:o,handleDeleteReel:i,handleShare:s,reportWatchTime:d,handleCtaClick:r}=G(),[f,v]=u.useState(null),[l,g]=u.useState(!1),p=m=>{const y=n.find(C=>C.id===m);y&&(v(y),g(!0))};return e.jsx(Y,{children:e.jsxs("div",{className:"reels-page",children:[e.jsx("style",{children:`
        .reels-page { position: relative; background: #000; height: 100dvh; width: 100%; overflow: hidden; font-family: 'Inter', sans-serif; color: white; overscroll-behavior: none; }
        .view-buttons-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 15px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); padding: 5px 15px; border-radius: 20px; }
        .view-btn { background: none; border: none; color: rgba(255, 255, 255, 0.6); font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .view-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); border-bottom: 2px solid #fff; }
        #searchIcon { position: fixed; top: 25px; right: 20px; z-index: 20; font-size: 22px; cursor: pointer; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        #reelsContent { height: 100%; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; overscroll-behavior: none; }
        #reelsContent::-webkit-scrollbar { display: none; }
        .reel-container-wrapper { height: 100%; width: 100%; scroll-snap-align: start; scroll-snap-stop: always; position: relative; }
        `}),e.jsxs("div",{className:"view-buttons-container",children:[e.jsx("button",{className:"view-btn",onClick:()=>t("/feed"),children:"Feed"}),e.jsx("button",{className:"view-btn active",children:"Reels"})]}),e.jsx("div",{id:"searchIcon",onClick:()=>t("/reels-search"),children:e.jsx("i",{className:"fa-solid fa-magnifying-glass"})}),e.jsx("div",{id:"reelsContent",ref:a,children:n.length===0?e.jsxs("div",{className:"flex items-center justify-center h-full flex-col gap-4",children:[e.jsx("i",{className:"fa-solid fa-video-slash text-4xl text-gray-600"}),e.jsx("p",{className:"text-gray-500",children:"Nenhum Reel dispon칤vel."}),e.jsx("button",{onClick:()=>t("/create-reel"),className:"px-4 py-2 bg-[#00c2ff] text-black rounded-lg font-bold shadow-[0_4px_10px_rgba(0,194,255,0.3)]",children:"Criar Reel Agora"})]}):n.map((m,y)=>e.jsx("div",{className:"reel-container-wrapper","data-index":y,children:e.jsx(K,{reel:m,isActive:y===h,onLike:()=>o(m.id),onComment:()=>p(m.id),onShare:()=>s(m),onDelete:()=>i(m.id),isOwner:m.authorId===j.getCurrentUserId(),onUserClick:()=>t(`/user/${m.username.replace("@","")}`),getDisplayName:C=>j.getUserByHandle(C)?.profile?.nickname||C,getUserAvatar:C=>j.getUserByHandle(C)?.profile?.photoUrl,isExpanded:x.has(m.id),onToggleExpand:C=>c(m.id,C),reportWatchTime:d,onCtaClick:r,onGroupClick:(C,E)=>t(E.isVip?`/vip-group-sales/${C}`:`/group-landing/${C}`)})},m.id))}),e.jsx(Q,{reel:f,isOpen:l,onClose:()=>g(!1)})]})})};export{ce as Reels};

import{j as a,u as U,g as w,c as y,f as Q,e as Y,r as e,k as b}from"./index-BC19Iu_T.js";import{C as Z,Y as _,M as J,a as K}from"./MessageItem-X0sf7ji-.js";const W=({isOpen:c,onClose:i,onSearch:v,onClear:l,onSettings:n,onDelete:d,onLeave:f,isCreator:h,isAdmin:r=!1})=>{if(!c)return null;const I=h||r,k=[{label:"Pesquisar",icon:"fa-solid fa-magnifying-glass",onClick:v},I?{label:"Limpar Mensagens",icon:"fa-solid fa-broom",onClick:l}:null,I?{label:"Configurações",icon:"fa-solid fa-gear",onClick:n}:null,h?{label:"Excluir Grupo",icon:"fa-solid fa-trash",onClick:d,isDestructive:!0}:null,{label:"Sair do Grupo",icon:"fa-solid fa-right-from-bracket",onClick:f,isDestructive:!0}].filter(Boolean);return a.jsx("div",{className:"fixed inset-0 z-[100] bg-transparent",onClick:i,children:a.jsx("div",{className:"absolute top-[70px] right-4 w-[240px] bg-[#1a1e26] rounded-2xl p-2 shadow-2xl animate-pop-in border border-white/10",onClick:u=>u.stopPropagation(),children:a.jsx("div",{className:"flex flex-col gap-1",children:k.map((u,A)=>a.jsxs("button",{onClick:()=>{u?.onClick(),i()},className:`w-full flex items-center gap-3 p-3 rounded-xl transition-all active:scale-[0.98] ${u?.isDestructive?"hover:bg-red-500/10 text-red-400":"hover:bg-white/5 text-white"}`,children:[a.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${u?.isDestructive?"bg-red-500/20":"bg-[#00c2ff1a]"}`,children:a.jsx("i",{className:`${u?.icon} ${u?.isDestructive?"text-red-400":"text-[#00c2ff]"} text-xs`})}),a.jsx("span",{className:"font-bold text-xs",children:u?.label})]},A))})})})},X=()=>{const c=U();return{validateGroupAccess:l=>{const n=y.getCurrentUserId(),d=w.getGroupById(l);if(!d||!n)return c("/groups"),!1;const f=d.creatorId===n,h=d.adminIds?.includes(n);if(d.isVip&&!f&&!h){const r=w.checkVipStatus(l,n);if(r==="none"||r==="expired")return c(`/vip-group-sales/${l}`),!1}return!0},navigateToGroupEntry:l=>{const n=w.getGroupById(l);if(!n)return;const d=n.channels&&n.channels.length>0;n.isSalesPlatformEnabled?c(`/group-platform/${l}`):c(d?`/group/${l}/channels`:`/group-chat/${l}`)}}},me=()=>{const c=U(),{id:i,channelId:v}=Q(),{showConfirm:l,showOptions:n}=Y(),{validateGroupAccess:d}=X(),[f,h]=e.useState(null),[r,I]=e.useState(v||"general"),[k,u]=e.useState(!1),[A,O]=e.useState(!1),[D,P]=e.useState([]),[ee,te]=e.useState(!1),T=e.useRef(null),[se,ae]=e.useState(!1),[ne,oe]=e.useState(""),[j,m]=e.useState(!1),[C,M]=e.useState([]),[L,ie]=e.useState(null);e.useRef(null);const[le,R]=e.useState(null),[re,ce]=e.useState(null),[de,ue]=e.useState(""),[fe,ge]=e.useState(!1),[V,$]=e.useState(!1),E=y.getCurrentUserEmail()?.toLowerCase(),G=y.getCurrentUserId(),g=e.useMemo(()=>`${i}_${r}`,[i,r]),x=e.useCallback(()=>{if(g){const t=b.getChat(g).messages||[],o=new Map;t.forEach(S=>{(S.deletedBy||[]).includes(E||"")||o.set(S.id,S)});const p=Array.from(o.values()).sort((S,B)=>S.id-B.id);P(p)}},[g,E]);e.useEffect(()=>{if(i){if(!d(i))return;const t=w.getGroupById(i);if(t){h(t);const o=t.creatorId===G,p=o||G&&t.adminIds?.includes(G);u(o),O(!!p),x(),b.markChatAsRead(g)}}},[i,r,g,x]),e.useEffect(()=>{const s=db.subscribe("chats",x);return()=>s()},[x]);const H=s=>{const t=y.getCurrentUser(),o={id:Date.now(),senderName:t?.profile?.nickname||t?.profile?.name||"Você",senderAvatar:t?.profile?.photoUrl,senderEmail:t?.email,text:s,type:"sent",contentType:"text",timestamp:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),status:"sent",deletedBy:[]};b.sendMessage(g,o)},q=s=>{M(t=>{const o=t.includes(s)?t.filter(p=>p!==s):[...t,s];return o.length===0&&m(!1),o})},z=s=>{m(!0),M([s]),navigator.vibrate&&navigator.vibrate(10)},F=async()=>{if(C.length===0)return;const s=await n("Excluir Mensagem",[{label:"Excluir para mim",value:"me",icon:"fa-solid fa-user"},{label:"Excluir para todos",value:"all",icon:"fa-solid fa-users",isDestructive:!0}]);s&&(await b.deleteMessages(g,C,s),m(!1),M([]),x())},N=e.useMemo(()=>r==="general"?"Geral":f?.channels?.find(s=>s.id===r)?.name||"Tópico",[f,r]);return a.jsxs("div",{className:`h-[100dvh] flex flex-col overflow-hidden ${f?.isVip?"secure-content":""}`,style:{background:"radial-gradient(circle at top left, #0c0f14, #0a0c10)",color:"#fff"},children:[a.jsx(Z,{title:f?.name||"Carregando...",subtitle:`#${N}`,avatar:f?.coverImage,onBack:()=>c("/groups"),isSelectionMode:j,selectedCount:C.length,onCancelSelection:()=>{m(!1),M([])},onDeleteSelection:F,onMenuClick:()=>$(!0)}),a.jsx("main",{style:{flexGrow:1,width:"100%",display:"flex",flexDirection:"column",paddingTop:"60px"},children:a.jsx(_,{ref:T,style:{height:"100%",paddingBottom:"80px"},data:D,initialTopMostItemIndex:D.length-1,followOutput:"smooth",itemContent:(s,t)=>a.jsx(J,{msg:t,isMe:t.senderEmail?.toLowerCase()===E,isSelectionMode:j,isSelected:C.includes(t.id),onSelect:q,onStartSelection:z,onMediaClick:(o,p)=>R({url:o,type:p}),playingAudioId:L,onPlayAudio:()=>{}},t.id)})}),!j&&a.jsx(K,{onSendMessage:H,onSendAudio:()=>{},onFileSelect:()=>{},canPost:!0,placeholder:`Conversar em #${N}...`}),a.jsx(W,{isOpen:V,onClose:()=>$(!1),isCreator:k,isAdmin:A,onSearch:()=>{},onClear:()=>m(!0),onSettings:()=>c(`/group-settings/${i}`),onDelete:()=>{},onLeave:()=>{}})]})};export{me as GroupChat};

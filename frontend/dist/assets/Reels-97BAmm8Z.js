import{r as e,i as t,f as r,a,c as s,e as n,u as i,j as o,g as l}from"./index-Bkpya5GW.js";import{r as c}from"./reelsService-VBA_uquZ.js";import{p as d}from"./postService-B_maMF9u.js";import"./MarketEngine-B3BMORQe.js";import{U as p,A as m}from"./UserBadge-B6APxn0Y.js";import{C as u}from"./CommentSheet-3zGuwS32.js";import{r as h}from"./recommendationService-BF61pFqn.js";import{a as f}from"./apiClient-Ccqh0pvL.js";import"./UserAvatar-B4jG9SAR.js";import"./CommentItem-Q0Zd2s3l.js";const x=()=>{const{id:n}=r(),i=a().state,[o,l]=e.useState([]),p=e.useCallback(async()=>{try{const e=s.getCurrentUserEmail(),t="true"===localStorage.getItem("settings_18_plus");let r=[];if(null==i?void 0:i.authorId)r=c.getReelsByAuthor(i.authorId,t);else if(r=c.getReels(e||void 0,t),n&&!r.find(e=>e.id===n)){const e=d.getPostById(n);e&&"video"===e.type&&(r=[e,...r])}l(r)}catch(e){}},[n,null==i?void 0:i.authorId]);e.useEffect(()=>{(async()=>{try{await c.fetchReels(),p()}catch(e){}})()},[p]);const m=e.useCallback(()=>{l(e=>{let r=!1;const a=e.map(e=>{const a=t.posts.findById(e.id);return!a||a.likes===e.likes&&a.comments===e.comments&&a.views===e.views&&a.liked===e.liked?e:(r=!0,{...e,...a})});return r?a:e})},[l]);var u,h;return u="posts",h=m,e.useEffect(()=>{const e=t.subscribe(u,h);return()=>{e()}},[u,h,t]),{reels:o,setReels:l}},g=()=>{const t=i(),{reels:r,setReels:a}=x(),o=e.useRef(null),{activeReelIndex:l,reportWatchTime:p}=((t,r)=>{const[a,n]=e.useState(0),i=e.useRef(new Set),o=e.useRef(0);return e.useEffect(()=>{const e=r.current;if(!e||0===t.length)return;const a=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const r=Number(e.target.getAttribute("data-index"));n(r);const a=t[r];a&&!i.current.has(a.id)&&(i.current.add(a.id),c.incrementView(a.id)),o.current=Date.now()}})},{threshold:.6});return e.querySelectorAll(".reel-container-wrapper").forEach(e=>a.observe(e)),()=>a.disconnect()},[t,r]),{activeReelIndex:a,reportWatchTime:e=>{const r=s.getCurrentUserEmail();e&&o.current&&r&&(Date.now(),o.current,t.find(t=>t.id===e),o.current=Date.now())}}})(r,o),{handleLike:m,handleDeleteReel:u,handleShare:h}=(e=>{const{showConfirm:t}=n();return{handleLike:async t=>{e(e=>e.map(e=>{if(e.id===t){const t=!e.liked,r=e.likes+(t?1:-1);return{...e,liked:t,likes:r}}return e})),await c.toggleLike(t)},handleDeleteReel:async r=>{await t("Excluir Reel","Tem certeza que deseja excluir este reel? A a칞칚o n칚o pode ser desfeita.","Excluir","Cancelar")&&(await d.deletePost(r),e(e=>e.filter(e=>e.id!==r)))},handleShare:async e=>{const t=`${window.location.origin}/#/post/${e.id}`;if(navigator.share)try{await navigator.share({title:"Confira este Reel!",url:t}),d.incrementShare(e.id)}catch(r){}else navigator.clipboard.writeText(t),alert("Link copiado!"),d.incrementShare(e.id)}}})(a),[f,g]=e.useState(new Set);return{navigate:t,containerRef:o,reels:r,activeReelIndex:l,expandedReels:f,toggleReadMore:(e,t)=>{t.stopPropagation(),g(t=>{const r=new Set(t);return r.has(e)?r.delete(e):r.add(e),r})},handleLike:m,handleDeleteReel:u,handleShare:h,reportWatchTime:p,handleCtaClick:e=>{(null==e?void 0:e.startsWith("http"))?window.open(e,"_blank"):e&&t(e)}}},v=({reel:t,isActive:r,reportWatchTime:a,onVideoClick:s,isMuted:n,onToggleMute:i})=>{const l=e.useRef(null),[c,d]=e.useState(!1),[p,m]=e.useState(!0),[u,h]=e.useState(!1),f=(x=t.video)?x.startsWith("http")||x.startsWith("data:")||x.startsWith("blob:")?x:`${window.location.origin}${x.startsWith("/")?"":"/"}${x}`:"";var x;return e.useEffect(()=>{let e=!0;if(r){if(l.current&&!u&&f){const r=l.current.play();void 0!==r&&r.then(()=>{e&&(d(!0),a(t.id))}).catch(t=>{e&&("NotAllowedError"===t.name?(d(!1),l.current&&(l.current.muted=!0,l.current.play().catch(e=>{}))):"AbortError"!==t.name&&d(!1))})}}else l.current&&(l.current.pause(),e&&d(!1),l.current.paused||Number.isNaN(l.current.duration)||(l.current.currentTime=0));return()=>{e=!1}},[r,u,f,t.id,a]),o.jsxs("div",{className:"reel-video-container w-full h-full relative",onClick:s,children:[r&&p&&!u&&f&&o.jsx("div",{className:"absolute z-10 flex items-center justify-center pointer-events-none",style:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:o.jsx("i",{className:"fa-solid fa-circle-notch fa-spin text-4xl text-white/80"})}),!c&&!p&&!u&&f&&o.jsx("div",{className:"absolute z-10 pointer-events-none bg-black/30 rounded-full p-4 backdrop-blur-sm",style:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:o.jsx("i",{className:"fa-solid fa-play text-4xl text-white/90 pl-1"})}),f&&!u?o.jsx("video",{ref:l,src:f,loop:!0,muted:n,playsInline:!0,"webkit-playsinline":"true",preload:"auto",className:"reel-video",onWaiting:()=>m(!0),onPlaying:()=>m(!1),onLoadedData:()=>m(!1),onError:()=>{f&&(h(!0),m(!1))}}):t.image?o.jsx("img",{src:t.image,alt:"Reel Content",className:"reel-video object-cover"}):o.jsxs("div",{className:"video-error",children:[o.jsx("i",{className:"fa-solid fa-triangle-exclamation"}),o.jsx("p",{children:"Conte칰do indispon칤vel"}),o.jsxs("button",{onClick:e=>{e.stopPropagation(),h(!1),m(!0)},className:"retry-btn",children:[o.jsx("i",{className:"fa-solid fa-rotate-right"})," Recarregar"]})]})]})},b=({reel:e,isOwner:t,isMuted:r,onLike:a,onComment:s,onShare:n,onDelete:i,onToggleMute:l})=>o.jsxs("div",{className:"reel-actions",children:[o.jsxs("button",{onClick:e=>{e.stopPropagation(),a()},children:[o.jsx("i",{className:"fa-solid fa-heart "+(e.liked?"liked-heart":"")}),o.jsx("span",{children:e.likes})]}),o.jsxs("button",{onClick:e=>{e.stopPropagation(),s()},children:[o.jsx("i",{className:"fa-solid fa-comment-dots"}),o.jsx("span",{children:e.comments})]}),o.jsx("button",{onClick:e=>{e.stopPropagation(),n()},children:o.jsx("i",{className:"fa-solid fa-share"})}),t&&o.jsx("button",{onClick:e=>{e.stopPropagation(),i()},style:{color:"#ff4d4d"},children:o.jsx("i",{className:"fa-solid fa-trash"})}),o.jsx("button",{onClick:l,children:o.jsx("i",{className:"fa-solid "+(r?"fa-volume-xmark":"fa-volume-high")})})]}),k={conferir:"fa-eye",participar:"fa-user-group",comprar:"fa-cart-shopping",assinar:"fa-credit-card",entrar:"fa-arrow-right-to-bracket",descubra:"fa-compass",baixar:"fa-download","saiba mais":"fa-circle-info"},j=({reel:t,displayName:r,avatar:a,onUserClick:s,onGroupClick:n,onCtaClick:i,isExpanded:c,onToggleExpand:d})=>{const[u,h]=e.useState(null),[f,x]=e.useState(!1);e.useEffect(()=>{if(t.relatedGroupId){const e=l.getGroupById(t.relatedGroupId);h(e||null)}else h(null)},[t.relatedGroupId]);return o.jsxs("div",{className:"reel-desc-overlay",children:[t.isAd&&t.ctaLink?o.jsxs("button",{className:"bg-[#00c2ff] text-black border-none px-5 py-3 rounded-xl text-xs font-black flex items-center justify-between w-full mt-3 shadow-[0_4px_15px_rgba(0,194,255,0.3)] active:scale-95",onClick:()=>i(t.ctaLink),style:{pointerEvents:"auto"},children:[o.jsxs("div",{className:"flex items-center gap-2.5",children:[o.jsx("i",{className:`fa-solid ${((e="")=>{const t=e.toLowerCase();return k[t]||"fa-arrow-right"})(t.ctaText)}`}),o.jsx("span",{className:"uppercase tracking-wider",children:t.ctaText||"Saiba Mais"})]}),o.jsx("i",{className:"fa-solid fa-chevron-right opacity-50"})]}):u&&o.jsxs("button",{className:"reel-group-btn",onClick:()=>n(u.id,u),style:u.isVip?{background:"linear-gradient(90deg, #FFD700, #B8860B)",color:"#000",border:"none",fontWeight:"800"}:{background:"rgba(255, 255, 255, 0.15)",color:"#fff",border:"1px solid rgba(255,255,255,0.1)"},children:[o.jsx("i",{className:"fa-solid "+(u.isVip?"fa-crown":"fa-users"),style:{color:u.isVip?"#000":"inherit"}}),o.jsx("span",{className:"truncate max-w-[150px]",children:u.isVip?`VIP: ${u.name}`:u.name}),o.jsx("i",{className:"fa-solid fa-chevron-right",style:{fontSize:"10px"}})]}),o.jsxs("div",{className:"reel-username",children:[o.jsx(p,{avatarUrl:a,nickname:r,handle:t.username,isVip:t.isAd,avatarSize:"sm",showHandle:!1,onAvatarClick:e=>{e.stopPropagation(),a?x(!0):s()},onNameClick:s}),t.isAdultContent&&o.jsx("span",{className:"adult-badge",children:"18+"}),t.isAd&&o.jsx("span",{className:"sponsored-badge",children:"Patrocinado"})]}),o.jsx("div",{className:"reel-title mt-1",children:c?t.text:o.jsxs(o.Fragment,{children:[t.text.slice(0,60),t.text.length>60&&o.jsx("span",{className:"reel-read-more",onClick:d,children:"mais"})]})}),o.jsxs("div",{style:{fontSize:"12px",color:"#aaa",marginTop:"10px",display:"flex",alignItems:"center",gap:"4px"},children:[o.jsx("i",{className:"fa-solid fa-play"})," ",t.views," visualiza칞칫es"]}),o.jsx(m,{isOpen:f,onClose:()=>x(!1),imageSrc:a||"",username:r})]})},C=({reel:t,isActive:r,isOwner:a,onLike:s,onComment:n,onShare:i,onDelete:l,onUserClick:c,getDisplayName:d,getUserAvatar:p,isExpanded:m,onToggleExpand:u,reportWatchTime:h,onCtaClick:f,onGroupClick:x})=>{const[g,k]=e.useState(!1),C=e=>{e.stopPropagation(),k(!g)};return o.jsxs("div",{className:"reel",children:[o.jsx(v,{reel:t,isActive:r,reportWatchTime:h,isMuted:g,onToggleMute:C,onVideoClick:()=>{}}),o.jsx(b,{reel:t,isOwner:a,isMuted:g,onLike:s,onComment:n,onShare:i,onDelete:l,onToggleMute:C}),o.jsx(j,{reel:t,displayName:d(t.username),avatar:p(t.username),onUserClick:c,onGroupClick:x,onCtaClick:f,isExpanded:m,onToggleExpand:u})]})},y={async getComments(e){try{return(await f.get(`/reels/${e}/comments`)).data}catch(t){throw t}},async addComment(e,t){try{return(await f.post(`/reels/${e}/comments`,{content:t})).data}catch(r){throw r}},async deleteComment(e){try{await f.delete(`/comments/${e}`)}catch(t){throw t}}},w=({reel:t,isOpen:r,onClose:a})=>{const{showConfirm:l}=n(),c=i(),[p,m]=e.useState([]),[f,x]=e.useState(!1),[g,v]=e.useState(""),[b,k]=e.useState(null),j=null==t?void 0:t.id,C=s.getCurrentUser(),w=null==C?void 0:C.id,N=e.useCallback(async e=>{if(e){x(!0);try{const t=await y.getComments(e);m(t)}catch(t){m([])}finally{x(!1)}}},[]);e.useEffect(()=>{r&&j?N(j):(m([]),v(""),k(null))},[r,j,N]);return o.jsx(u,{isOpen:r,onClose:a,title:`Coment치rios (${p.length})`,comments:p,commentText:g,onCommentTextChange:v,onSend:async()=>{var e,r;if(!j||!g.trim())return;const a=s.getCurrentUser();if(a)if(b){const t=(null==(e=a.profile)?void 0:e.name)||"user",s=null==(r=a.profile)?void 0:r.photoUrl;d.addReply(j,b.id,g.trim(),t,s)&&(k(null),v(""),N(j))}else try{await y.addComment(j,g.trim()),v(""),await N(j),a.email&&t&&h.recordInteraction(a.email,t,"comment")}catch(n){}},onLike:e=>{j&&(d.toggleCommentLike(j,e),m(t=>t.map(t=>t.id===e?{...t,isLiked:!t.isLiked,likes:t.isLiked?t.likes-1:t.likes+1}:t)))},onDelete:async e=>{if(j&&await l("Excluir coment치rio","Deseja excluir este coment치rio?","Excluir","Cancelar"))try{await y.deleteComment(e),await N(j)}catch(t){}},onUserClick:e=>{c(`/user/${e.replace("@","")}`),a()},currentUserId:w,replyingTo:b,onCancelReply:()=>k(null),onReplyClick:(e,t)=>k({id:e,username:t})})};class N extends e.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){fetch("/api/errors/log-reels-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:{message:e.message,stack:e.stack},errorInfo:{componentStack:t.componentStack}})}).catch(e=>{})}render(){return this.state.hasError?o.jsxs("div",{style:S.container,children:[o.jsx("div",{style:S.icon,children:"游꿟游눤"}),o.jsx("h1",{style:S.title,children:"Ocorreu um Erro nos Reels"}),o.jsx("p",{style:S.message,children:"Um problema inesperado aconteceu. Nossa equipe j치 foi notificada."}),o.jsx("p",{style:S.details,children:"Detalhes do erro foram registrados para an치lise."}),o.jsx("button",{style:S.button,onClick:()=>window.location.reload(),children:"Tentar Novamente"})]}):this.props.children}}const S={container:{width:"100%",height:"100dvh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",background:"#000",color:"#fff",fontFamily:"Inter, sans-serif",padding:"20px",textAlign:"center",boxSizing:"border-box"},icon:{fontSize:"48px",marginBottom:"20px"},title:{fontSize:"24px",fontWeight:"bold",color:"#ff4d4d",marginBottom:"10px"},message:{fontSize:"16px",color:"#ccc",maxWidth:"400px",lineHeight:1.5},details:{fontSize:"12px",color:"#888",marginTop:"20px"},button:{marginTop:"30px",padding:"12px 25px",background:"#00c2ff",color:"#000",border:"none",borderRadius:"25px",fontWeight:"bold",cursor:"pointer",transition:"transform 0.2s, box-shadow 0.2s",boxShadow:"0 4px 15px rgba(0, 194, 255, 0.3)"}},R=()=>{const{navigate:t,containerRef:r,reels:a,activeReelIndex:n,expandedReels:i,toggleReadMore:l,handleLike:c,handleDeleteReel:d,handleShare:p,reportWatchTime:m,handleCtaClick:u}=g(),[h,f]=e.useState(null),[x,v]=e.useState(!1);return o.jsx(N,{children:o.jsxs("div",{className:"reels-page",children:[o.jsx("style",{children:"\n        .reels-page { position: relative; background: #000; height: 100dvh; width: 100%; overflow: hidden; font-family: 'Inter', sans-serif; color: white; overscroll-behavior: none; }\n        .view-buttons-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 15px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); padding: 5px 15px; border-radius: 20px; }\n        .view-btn { background: none; border: none; color: rgba(255, 255, 255, 0.6); font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; }\n        .view-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); border-bottom: 2px solid #fff; }\n        #searchIcon { position: fixed; top: 25px; right: 20px; z-index: 20; font-size: 22px; cursor: pointer; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }\n        #reelsContent { height: 100%; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; overscroll-behavior: none; }\n        #reelsContent::-webkit-scrollbar { display: none; }\n        .reel-container-wrapper { height: 100%; width: 100%; scroll-snap-align: start; scroll-snap-stop: always; position: relative; }\n        "}),o.jsxs("div",{className:"view-buttons-container",children:[o.jsx("button",{className:"view-btn",onClick:()=>t("/feed"),children:"Feed"}),o.jsx("button",{className:"view-btn active",children:"Reels"})]}),o.jsx("div",{id:"searchIcon",onClick:()=>t("/reels-search"),children:o.jsx("i",{className:"fa-solid fa-magnifying-glass"})}),o.jsx("div",{id:"reelsContent",ref:r,children:0===a.length?o.jsxs("div",{className:"flex items-center justify-center h-full flex-col gap-4",children:[o.jsx("i",{className:"fa-solid fa-video-slash text-4xl text-gray-600"}),o.jsx("p",{className:"text-gray-500",children:"Nenhum Reel dispon칤vel."}),o.jsx("button",{onClick:()=>t("/create-reel"),className:"px-4 py-2 bg-[#00c2ff] text-black rounded-lg font-bold shadow-[0_4px_10px_rgba(0,194,255,0.3)]",children:"Criar Reel Agora"})]}):a.map((e,r)=>o.jsx("div",{className:"reel-container-wrapper","data-index":r,children:o.jsx(C,{reel:e,isActive:r===n,onLike:()=>c(e.id),onComment:()=>(e=>{const t=a.find(t=>t.id===e);t&&(f(t),v(!0))})(e.id),onShare:()=>p(e),onDelete:()=>d(e.id),isOwner:e.authorId===s.getCurrentUserId(),onUserClick:()=>t(`/user/${e.username.replace("@","")}`),getDisplayName:e=>{var t,r;return(null==(r=null==(t=s.getUserByHandle(e))?void 0:t.profile)?void 0:r.nickname)||e},getUserAvatar:e=>{var t,r;return null==(r=null==(t=s.getUserByHandle(e))?void 0:t.profile)?void 0:r.photoUrl},isExpanded:i.has(e.id),onToggleExpand:t=>l(e.id,t),reportWatchTime:m,onCtaClick:u,onGroupClick:(e,r)=>t(r.isVip?`/vip-group-sales/${e}`:`/group-landing/${e}`)})},e.id))}),o.jsx(w,{reel:h,isOpen:x,onClose:()=>v(!1)})]})})};export{R as Reels};

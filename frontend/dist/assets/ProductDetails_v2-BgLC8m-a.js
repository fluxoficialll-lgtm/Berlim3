import{c as I,r as l,e as R,u as T,j as e,f as q,k as H}from"./index-BC19Iu_T.js";import{m as S}from"./marketplaceService-ov_b-P0x.js";import{C as Q}from"./CommentSheet-Bk6VXXoJ.js";import"./CommentItem-BgB3JV1X.js";import"./postService-XFLx8Vj8.js";var i=[];for(var P=0;P<256;++P)i.push((P+256).toString(16).slice(1));function Z(t,s=0){return(i[t[s+0]]+i[t[s+1]]+i[t[s+2]]+i[t[s+3]]+"-"+i[t[s+4]]+i[t[s+5]]+"-"+i[t[s+6]]+i[t[s+7]]+"-"+i[t[s+8]]+i[t[s+9]]+"-"+i[t[s+10]]+i[t[s+11]]+i[t[s+12]]+i[t[s+13]]+i[t[s+14]]+i[t[s+15]]).toLowerCase()}var j,W=new Uint8Array(16);function G(){if(!j&&(j=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!j))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return j(W)}var J=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const E={randomUUID:J};function K(t,s,o){if(E.randomUUID&&!t)return E.randomUUID();t=t||{};var n=t.random||(t.rng||G)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Z(n)}const X=async t=>(console.log(`Buscando comentários para o item ${t}...`),await new Promise(o=>setTimeout(o,500)),(await db.table("comments").toArray()).filter(o=>o.itemId===t)),Y=async(t,s)=>{const o=I.getCurrentUser();if(!o)throw new Error("Usuário não autenticado");console.log(`Adicionando comentário ao item ${t}...`),await new Promise(a=>setTimeout(a,300));const n={id:K(),itemId:t,text:s,username:o.username||"Usuário Anônimo",avatar:o.avatar,timestamp:Date.now(),likes:0,replies:[]};return await db.table("comments").add(n),n},_=async t=>{if(console.log(`Deletando comentário ${t}...`),await new Promise(o=>setTimeout(o,300)),await db.table("comments").get(t))await db.table("comments").delete(t);else throw new Error("Comentário não encontrado")},D={getComments:X,addComment:Y,deleteComment:_},ee=t=>{const[s,o]=l.useState([]),[n,a]=l.useState(!0),[x,c]=l.useState(null),{showConfirm:m}=R(),u=l.useCallback(async()=>{if(t){a(!0);try{const d=await D.getComments(t);o(d),c(null)}catch(d){console.error("Failed to fetch comments:",d),c("Não foi possível carregar os comentários.")}finally{a(!1)}}},[t]),b=async d=>{if(d.trim())try{await D.addComment(t,d.trim()),await u()}catch(h){console.error("Failed to add comment:",h),c("Não foi possível enviar o seu comentário.")}},v=async d=>{if(await m("Excluir comentário","Deseja realmente excluir este comentário?"))try{await D.deleteComment(d),await u()}catch(g){console.error("Failed to delete comment:",g),c("Não foi possível excluir o comentário.")}};return l.useEffect(()=>{u()},[u]),{comments:s,loading:n,error:x,fetchComments:u,addComment:b,deleteComment:v}},te=({isSeller:t,onDelete:s,onReport:o,onMediaClick:n,mediaItems:a})=>{const x=T(),c=a[0];return e.jsxs("div",{className:"relative w-full h-[40vh] bg-black group cursor-pointer",onClick:()=>c&&n(c),children:[c&&e.jsx("img",{src:c.url,alt:"Product Background",className:"absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-70 transition-opacity"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-[#0c0f14] via-transparent to-black/30"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-16 h-16 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 group-hover:scale-110 transition-all duration-300 scale-90",children:e.jsx("i",{className:"fa-solid fa-expand text-white text-2xl"})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10",children:[e.jsx("button",{onClick:m=>{m.stopPropagation(),x(-1)},className:"w-10 h-10 bg-black/40 rounded-full flex items-center justify-center backdrop-blur-sm",children:e.jsx("i",{className:"fa-solid fa-arrow-left text-white"})}),t?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:m=>{m.stopPropagation(),x(`/edit-product/${productId}`)},className:"h-10 px-4 bg-black/40 rounded-full flex items-center justify-center backdrop-blur-sm",children:[e.jsx("i",{className:"fa-solid fa-pen-to-square mr-2"})," Editar"]}),e.jsx("button",{onClick:m=>{m.stopPropagation(),s()},className:"w-10 h-10 bg-red-500/50 rounded-full flex items-center justify-center backdrop-blur-sm",children:e.jsx("i",{className:"fa-solid fa-trash"})})]}):e.jsx("button",{onClick:m=>{m.stopPropagation(),o()},className:"w-10 h-10 bg-black/40 rounded-full flex items-center justify-center backdrop-blur-sm",children:e.jsx("i",{className:"fa-solid fa-ellipsis-vertical"})})]})]})},se=({title:t,price:s,location:o,category:n,timestamp:a})=>{const x=()=>n==="Vagas de Emprego"?"A combinar":`R$ ${s.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;return e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"product-title",children:t}),e.jsx("div",{className:"product-price",children:x()}),e.jsxs("div",{className:"badges-row",children:[e.jsxs("div",{className:"badge-item",children:[e.jsx("i",{className:"fa-solid fa-location-dot"})," ",o]}),e.jsxs("div",{className:"badge-item",children:[e.jsx("i",{className:"fa-solid fa-tag"})," ",n]}),e.jsxs("div",{className:"badge-item",children:[e.jsx("i",{className:"fa-solid fa-clock"})," ",new Date(a).toLocaleDateString()]})]})]})},ae=({sellerName:t,sellerAvatar:s,onClick:o})=>e.jsxs("div",{className:"seller-card",onClick:o,children:[e.jsxs("div",{className:"seller-left",children:[s?e.jsx("img",{src:s,className:"seller-avatar",alt:"Seller"}):e.jsx("div",{className:"seller-avatar bg-gray-700 flex items-center justify-center text-xs",children:e.jsx("i",{className:"fa-solid fa-user"})}),e.jsxs("div",{className:"seller-info",children:[e.jsx("h4",{children:t}),e.jsx("p",{children:"Ver perfil completo"})]})]}),e.jsx("i",{className:"fa-solid fa-chevron-right store-icon"})]}),oe=({description:t})=>e.jsxs("div",{className:"desc-section",children:[e.jsxs("h3",{className:"section-header",children:[e.jsx("i",{className:"fa-solid fa-align-left text-[#00c2ff]"})," Detalhes"]}),e.jsx("p",{className:"desc-text",children:t||"Sem descrição fornecida pelo vendedor."})]}),ne=({isSeller:t,onDelete:s,onChat:o})=>e.jsx("div",{className:"bottom-bar",children:t?e.jsxs("button",{className:"action-btn btn-danger",onClick:s,children:[e.jsx("i",{className:"fa-solid fa-trash"})," Excluir Anúncio"]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"action-btn btn-secondary",onClick:()=>{alert("Adicionado aos favoritos!")},children:e.jsx("i",{className:"fa-regular fa-heart"})}),e.jsxs("button",{className:"action-btn btn-primary",onClick:o,children:[e.jsx("i",{className:"fa-brands fa-whatsapp"})," Conversar / Negociar"]})]})}),re=({media:t,onClose:s})=>t?e.jsxs("div",{className:"fixed inset-0 z-[60] bg-black bg-opacity-95 flex items-center justify-center p-2",onClick:s,children:[e.jsx("button",{className:"absolute top-4 right-4 text-white text-4xl bg-black/50 rounded-full w-10 h-10 flex items-center justify-center z-50",onClick:s,children:"×"}),t.type==="video"?e.jsx("video",{src:t.url,controls:!0,autoPlay:!0,className:"max-w-full max-h-full object-contain shadow-2xl",onClick:o=>o.stopPropagation()}):e.jsx("img",{src:t.url,alt:"Zoom",className:"max-w-full max-h-full object-contain rounded-lg shadow-2xl",onClick:o=>o.stopPropagation()})]}):null,ue=()=>{const t=T(),{id:s}=q(),{showConfirm:o,showAlert:n}=R(),[a,x]=l.useState(null),[c,m]=l.useState(!0),[u,b]=l.useState(!1),[v,d]=l.useState(null),[h,g]=l.useState(!1),f=I.getCurrentUser(),A=f?.id,{comments:N,loading:M,addComment:$,deleteComment:L}=ee(s||""),[C,y]=l.useState(""),[w,k]=l.useState(null);l.useEffect(()=>{if(s){const r=S.getItemById(s);r?(x(r),f&&(f.email===r.sellerId||f.id===r.sellerId)&&b(!0)):(n("Erro","Produto não encontrado."),t("/marketplace"))}m(!1)},[s,f,t,n]);const F=async r=>{if(r.stopPropagation(),!(!f||!a||u))try{const p=await H.startChatWithProductContext(a.sellerId,a.id);t(`/chat/${p}`)}catch(p){console.error(p),n("Erro","Não foi possível iniciar a conversa. Tente novamente.")}},U=()=>{o("Excluir Anúncio","Tem certeza que deseja excluir permanentemente?","Excluir","Cancelar").then(r=>{r&&s&&(S.deleteItem(s),t("/marketplace",{replace:!0}))})},V=async()=>{!C.trim()||!a||!f||(w?(console.log("Respondendo a",w),k(null),y("")):(await $(C),y("")))},z=r=>{a&&S.toggleCommentLike(a.id,r)},B=()=>{a&&t(`/user/${a.sellerName}`,{state:{activeTab:"products"}})},O=l.useMemo(()=>a?[{type:"video",url:a.video},{type:"image",url:a.image},...a.images?.map(r=>({type:"image",url:r}))||[]].filter(r=>r.url):[],[a]);return c||!a?e.jsx("div",{className:"min-h-screen bg-[#0c0f14] flex items-center justify-center text-white",children:e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin text-2xl"})}):e.jsxs("div",{className:"min-h-screen bg-[#0c0f14] text-white font-['Inter'] flex flex-col relative pb-[90px]",children:[e.jsx(te,{isSeller:u,productId:a.id,onDelete:U,onReport:()=>n("Reportado","Obrigado!"),mediaItems:O,onMediaClick:r=>d(r)}),e.jsx("div",{className:"product-container -mt-16 relative z-10",children:e.jsxs("div",{className:"details-wrapper",children:[e.jsx(se,{title:a.title,price:a.price,location:a.location,category:a.category,timestamp:a.timestamp}),e.jsx(ae,{sellerName:a.sellerName||"Vendedor",sellerAvatar:a.sellerAvatar,onClick:B}),e.jsx(oe,{description:a.description}),e.jsxs("button",{className:"qa-trigger-btn",onClick:()=>g(!0),children:[e.jsxs("span",{className:"font-bold text-sm",children:[e.jsx("i",{className:"fa-regular fa-comments mr-2 text-[#00c2ff]"})," Perguntas (",N.length,")"]}),e.jsx("i",{className:"fa-solid fa-chevron-right text-xs"})]})]})}),e.jsx(ne,{isSeller:u,onDelete:U,onChat:F}),e.jsx(re,{media:v,onClose:()=>d(null)}),e.jsx(Q,{isOpen:h,onClose:()=>g(!1),title:`Perguntas (${N.length})`,comments:N,loading:M,commentText:C,onCommentTextChange:y,onSend:V,onLike:z,onDelete:L,onUserClick:r=>t(`/user/${r.replace("@","")}`),currentUserId:A,replyingTo:w,onCancelReply:()=>k(null),onReplyClick:(r,p)=>k({id:r,username:p}),placeholder:u?"Responda a dúvida...":"Escreva sua dúvida..."})]})};export{ue as ProductDetailsV2};

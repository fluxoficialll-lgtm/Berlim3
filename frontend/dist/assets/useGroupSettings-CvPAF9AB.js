import{r as t,c as x,g as I,i as U,u as k,f as T,e as V,s as R}from"./index-BC19Iu_T.js";const O=e=>{const[s,n]=t.useState(""),[m,o]=t.useState(""),[d,u]=t.useState(void 0);return t.useEffect(()=>{e&&(n(e.name||""),o(e.description||""),u(e.coverImage))},[e]),{state:{groupName:s,description:m,coverImage:d},actions:{setGroupName:n,setDescription:o,setCoverImage:u},getIdentityPayload:()=>({name:s,description:m,coverImage:d})}},B=e=>{const[s,n]=t.useState(!1),[m,o]=t.useState(!1),[d,u]=t.useState("30"),[f,b]=t.useState([]),[S,p]=t.useState(!1),[M,v]=t.useState("");return t.useEffect(()=>{if(e?.settings){const a=e.settings;n(a.onlyAdminsPost||!1),o(a.msgSlowMode||!1),u(a.msgSlowModeInterval?.toString()||"30"),b(a.forbiddenWords||[]),p(a.approveMembers||!1),v(a.memberLimit||"")}},[e]),{state:{onlyAdminsPost:s,msgSlowMode:m,msgSlowModeInterval:d,forbiddenWords:f,approveMembers:S,memberLimit:M},actions:{setOnlyAdminsPost:n,setMsgSlowMode:o,setMsgSlowModeInterval:u,setForbiddenWords:b,setApproveMembers:p,setMemberLimit:v},getModerationPayload:()=>({settings:{onlyAdminsPost:s,msgSlowMode:m,msgSlowModeInterval:parseInt(d),forbiddenWords:f,approveMembers:S,memberLimit:M===""?void 0:Number(M)}})}},N=e=>{const[s,n]=t.useState(""),[m,o]=t.useState("BRL"),[d,u]=t.useState(null),[f,b]=t.useState(""),[S,p]=t.useState(""),[M,v]=t.useState(""),[a,i]=t.useState(""),[c,P]=t.useState([]);t.useEffect(()=>{e?.isVip&&(n(e.price||""),o(e.currency||"BRL"),u(e.selectedProviderId||null),b(e.pixelId||""),p(e.pixelToken||""),v(e.vipDoor?.text||""),i(e.vipDoor?.buttonText||""),P(e.vipDoor?.mediaItems||(e.vipDoor?.media?[{url:e.vipDoor.media,type:"image"}]:[])))},[e]);const C=(w,g)=>{const y=[...c],r=g==="left"?w-1:w+1;r<0||r>=y.length||([y[w],y[r]]=[y[r],y[w]],P(y))},D=t.useMemo(()=>({metaId:f,metaToken:S}),[f,S]);return{state:{vipPrice:s,vipCurrency:m,selectedProviderId:d,pixelId:f,pixelToken:S,vipDoorText:M,vipButtonText:a,vipMediaItems:c,pixelConfig:D},actions:{setVipPrice:n,setVipCurrency:o,setSelectedProviderId:u,setPixelId:b,setPixelToken:p,setVipDoorText:v,setVipButtonText:i,setVipMediaItems:P,updatePlatformPixel:(w,g)=>{w==="meta"&&(b(g.pixelId),p(g.pixelToken))},moveVipMediaItem:C},getVipPayload:()=>({price:s.replace(",","."),currency:m,selectedProviderId:d||void 0,pixelId:f,pixelToken:S,vipDoor:e?.isVip?{...e.vipDoor,text:M,buttonText:a,mediaItems:c}:void 0})}},F=e=>{const[s,n]=t.useState([]),[m,o]=t.useState([]),[d,u]=t.useState(!1),[f,b]=t.useState([]),[S,p]=t.useState(!0),[M,v]=t.useState(!1),[a,i]=t.useState([]);return t.useEffect(()=>{e&&(n(e.channels||[]),o(e.channelSections||[]),u(e.isSalesPlatformEnabled||!1),b(e.salesPlatformSections||[]),p(e.salesPlatformAllowDownload??!0),v(e.salesPlatformAllowMemberUpload??!1),i(e.links||[]))},[e]),{state:{channels:s,channelSections:m,isSalesPlatformEnabled:d,salesPlatformSections:f,salesPlatformAllowDownload:S,salesPlatformAllowMemberUpload:M,links:a},actions:{setChannels:n,setChannelSections:o,setIsSalesPlatformEnabled:u,setSalesPlatformSections:b,setSalesPlatformAllowDownload:p,setSalesPlatformAllowMemberUpload:v,setLinks:i},getStructurePayload:()=>({channels:s,channelSections:m,isSalesPlatformEnabled:d,salesPlatformSections:f,salesPlatformAllowDownload:S,salesPlatformAllowMemberUpload:M,links:a})}},W=e=>{const[s,n]=t.useState([]),[m,o]=t.useState([]),[d,u]=t.useState([]),[f,b]=t.useState(""),S=x.getCurrentUserId(),p=t.useCallback(a=>{if(a)try{const i=I.getGroupMembers(a)||[];n(i),o(I.getPendingMembers(a)||[])}catch(i){console.error("Erro ao carregar membros do grupo:",i)}},[]);t.useEffect(()=>{if(e){u(e.roles||[]),p(e.id);const a=U.subscribe("groups",()=>p(e.id));return()=>a()}},[e,p]);const M=t.useMemo(()=>{const a=s||[],i=f.toLowerCase().trim();return i?a.filter(c=>{const P=c.profile?.name?.toLowerCase()||"",C=c.profile?.nickname?.toLowerCase()||"";return P.includes(i)||C.includes(i)}):a},[s,f]);return{state:{members:t.useMemo(()=>{if(!e)return[];const a=M||[],i=e.userRoles||{};return a.map(c=>({id:c.id,name:c.profile?.nickname||c.profile?.name||"Membro Flux",role:c.id===e.creatorId?"Dono":e.adminIds?.includes(c.id)?"Admin":"Membro",roleId:i[c.id],isMe:c.id===S,avatar:c.profile?.photoUrl}))},[M,e,S]),pendingRequests:m,roles:d,searchQuery:f},actions:{setMembers:n,setPendingRequests:o,setRoles:u,refreshMembers:p,setSearchQuery:b},getMembersPayload:()=>({roles:d})}},H=()=>{const e=k(),{id:s}=T(),{showAlert:n,showConfirm:m}=V(),[o,d]=t.useState(null),[u,f]=t.useState(!0),[b,S]=t.useState(!1),[p,M]=t.useState(!1),v=O(o),a=B(o),i=N(o),c=F(o),P=W(o);t.useEffect(()=>{if(s){const r=x.getCurrentUserId(),l=I.getGroupById(s);if(l){d(l);const h=l.creatorId===r,A=h||r&&l.adminIds?.includes(r)||!1;S(h),M(A)}f(!1)}},[s]);const C=async()=>{if(!o)return;const r={...o,...v.getIdentityPayload(),...a.getModerationPayload(),...i.getVipPayload(),...c.getStructurePayload(),...P.getMembersPayload()};await I.updateGroup(r),await n("Sucesso","Configurações sincronizadas.")},D=async r=>{if(!o||!s)return;const l=x.getCurrentUserId();if(!l)return;const h=o.memberIds?.length||0;if(r==="leave"){let A="Sair do Grupo",G="Deseja realmente sair desta comunidade?",L="Sair";h===1?(A="⚠️ Aviso Crítico",G="Você é o último membro. Se sair agora, o grupo e todo o histórico serão APAGADOS permanentemente. Confirmar?",L="Apagar e Sair"):b&&(G="Você é o dono deste grupo. Ao sair, a posse será transferida automaticamente para o administrador ou membro mais forte. Continuar?"),await m(A,G,L,"Cancelar")&&((await R.processDeparture(s,l)).action==="dissolved"&&await n("Grupo Encerrado","O grupo foi removido pois não restaram membros."),e("/groups"))}else r==="delete"&&await m("EXCLUIR GRUPO","Esta ação apagará o grupo para TODOS os membros imediatamente. Não há volta. Confirmar?","Excluir Tudo","Cancelar")&&(await I.deleteGroup(s),e("/groups"))},E=(r,l)=>{s&&(l==="kick"?I.removeMember(s,r):l==="ban"?I.banMember(s,r):l==="promote"?I.promoteMember(s,r):l==="demote"&&I.demoteMember(s,r),P.actions.refreshMembers(s))},w=async(r,l)=>{s&&(l==="accept"?I.approveMember(s,r):I.rejectMember(s,r),P.actions.refreshMembers(s))},g=async r=>{if(!r.trim()||!o)return!1;const l=r.replace("@","").toLowerCase().trim(),h=await x.fetchUserByHandle(l);return h?(U.vipAccess.grant({userId:h.id,groupId:o.id,status:"active",purchaseDate:Date.now(),transactionId:`manual_${Date.now()}_admin`}),I.approveMember(o.id,h.id),P.actions.refreshMembers(o.id),await n("Sucesso",`Acesso VIP liberado para @${l}`),!0):(await n("Erro","Usuário não encontrado."),!1)},y={...v.state,...v.actions,...a.state,...a.actions,...i.state,...i.actions,...c.state,...c.actions,...P.state,...P.actions};return{group:o,loading:u,isOwner:b,isAdmin:p,handleSave:C,handleLeaveDelete:D,handleMemberAction:E,handlePendingAction:w,handleManualRelease:g,form:y}};export{H as u};

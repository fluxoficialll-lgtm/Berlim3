import{u as se,f as ae,e as ne,r as e,c as Y,k as _,B as Z,j as t}from"./index-BC19Iu_T.js";import{C as le,Y as oe,M as ie,a as ce}from"./MessageItem-X0sf7ji-.js";const re=()=>{const i=se(),{id:m}=ae(),{showConfirm:x,showOptions:C}=ne(),s=m||"1",[d,b]=e.useState([]),[f,l]=e.useState(""),[g,E]=e.useState(""),[I,D]=e.useState(void 0),[A,p]=e.useState("Offline"),[T,N]=e.useState(!1),O=e.useRef(null),[L,h]=e.useState(!1),[v,S]=e.useState([]),[U,$]=e.useState(!1),[M,B]=e.useState(""),[q,k]=e.useState(null),[w,P]=e.useState(null),[F,G]=e.useState(!1),y=Y.getCurrentUserEmail()?.toLowerCase(),j=e.useCallback((a=!1)=>{const n=_.getChat(s);if(!n){i("/messages");return}N(n.isBlocked);let c,u=n.contactName,R,z="";if(s.includes("_")&&s.includes("@")&&y){const r=s.split("_").find(o=>o.toLowerCase()!==y);if(r){const o=Object.values(db.users.getAll()).find(te=>te.email.toLowerCase()===r.toLowerCase());o?(c=o,u=o.profile?.nickname||o.profile?.name||`@${o.profile?.name}`,R=o.profile?.photoUrl,z=o.profile?.name||""):u=r.split("@")[0]}}l(u),D(R),E(z),c?.lastSeen&&Date.now()-c.lastSeen<120*1e3?p("Online"):p("Offline");const X=n.messages||[],H=new Map;X.forEach(r=>{(r.deletedBy||[]).includes(y||"")||H.set(r.id,r)});const ee=Array.from(H.values()).sort((r,o)=>r.id-o.id);b(ee)},[s,y,i]);e.useEffect(()=>{j();const a=Z.on("chat_deleted_globally",u=>{u.chatId===s&&i("/messages",{replace:!0})}),n=Z.on("messages_deleted_globally",u=>{u.chatId===s&&j(!0)}),c=db.subscribe("chats",()=>j(!0));return()=>{a(),n(),c()}},[s,j,i]);const V=a=>{const n=Y.getCurrentUser(),c={id:Date.now(),text:a,type:"sent",contentType:"text",timestamp:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),status:"sent",senderEmail:n?.email,senderAvatar:n?.profile?.photoUrl,senderName:n?.profile?.nickname||n?.profile?.name||"VocÃª",deletedBy:[]};_.sendMessage(s,c)},J=a=>{S(n=>{const c=n.includes(a)?n.filter(u=>u!==a):[...n,a];return c.length===0&&h(!1),c})},K=a=>{h(!0),S([a]),navigator.vibrate&&navigator.vibrate(10)},Q=async()=>{if(v.length===0)return;const a=await C("Excluir Mensagem",[{label:"Excluir para mim",value:"me",icon:"fa-solid fa-user"},{label:"Excluir para todos",value:"all",icon:"fa-solid fa-users",isDestructive:!0}]);a&&(await _.deleteMessages(s,v,a),h(!1),S([]),j(!0))},W=e.useMemo(()=>d.filter(a=>(a.text||"").toLowerCase().includes(M.toLowerCase())),[d,M]);return{navigate:i,chatId:s,messages:d,contactName:f,contactHandle:g,contactAvatar:I,contactStatus:A,isBlocked:T,virtuosoRef:O,isSelectionMode:L,setIsSelectionMode:h,selectedIds:v,setSelectedIds:S,isSearchOpen:U,setIsSearchOpen:$,searchTerm:M,setSearchTerm:B,playingAudioId:q,zoomedMedia:w,setZoomedMedia:P,isMenuModalOpen:F,setIsMenuModalOpen:G,currentUserEmail:y,handleSendMessage:V,handleToggleSelection:J,handleStartSelection:K,handleDeleteSelected:Q,filteredMessages:W}},de=({isOpen:i,onClose:m,onSearch:x,onSelect:C,onBlock:s,onClear:d,isBlocked:b})=>{if(!i)return null;const f=[{label:"Pesquisar",icon:"fa-solid fa-magnifying-glass",onClick:x},{label:"Selecionar",icon:"fa-solid fa-check-double",onClick:C},{label:b?"Desbloquear":"Bloquear",icon:"fa-solid fa-ban",onClick:s},{label:"Limpar conversa",icon:"fa-solid fa-trash-can",onClick:d,isDestructive:!0}];return t.jsx("div",{className:"fixed inset-0 z-[100] bg-transparent",onClick:m,children:t.jsx("div",{className:"absolute top-[70px] right-4 w-[220px] bg-[#1a1e26] rounded-2xl p-2 shadow-2xl animate-pop-in border border-white/10",onClick:l=>l.stopPropagation(),children:t.jsx("div",{className:"flex flex-col gap-1",children:f.map((l,g)=>t.jsxs("button",{onClick:()=>{l.onClick(),m()},className:`w-full flex items-center gap-3 p-3 rounded-xl transition-all active:scale-[0.98] ${l.isDestructive?"hover:bg-red-500/10 text-red-400":"hover:bg-white/5 text-white"}`,children:[t.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${l.isDestructive?"bg-red-500/20":"bg-[#00c2ff1a]"}`,children:t.jsx("i",{className:`${l.icon} ${l.isDestructive?"text-red-400":"text-[#00c2ff]"} text-xs`})}),t.jsx("span",{className:"font-bold text-xs",children:l.label})]},g))})})})},he=()=>{const{navigate:i,contactName:m,contactHandle:x,contactAvatar:C,contactStatus:s,isBlocked:d,virtuosoRef:b,isSelectionMode:f,setIsSelectionMode:l,selectedIds:g,setSelectedIds:E,isSearchOpen:I,setIsSearchOpen:D,searchTerm:A,setSearchTerm:p,playingAudioId:T,zoomedMedia:N,setZoomedMedia:O,isMenuModalOpen:L,setIsMenuModalOpen:h,currentUserEmail:v,handleSendMessage:S,handleToggleSelection:U,handleStartSelection:$,handleDeleteSelected:M,filteredMessages:B}=re();return t.jsxs("div",{className:"messages-page h-[100dvh] flex flex-col overflow-hidden",style:{background:"radial-gradient(circle at top left, #0c0f14, #0a0c10)",color:"#fff"},children:[t.jsx(le,{title:m,subtitle:d?"Bloqueado":s,avatar:C,onBack:()=>i("/messages"),onInfoClick:()=>x&&i(`/user/${x}`),isSelectionMode:f,selectedCount:g.length,onCancelSelection:()=>{l(!1),E([])},onDeleteSelection:M,isSearchOpen:I,onToggleSearch:()=>{D(!I),p("")},searchTerm:A,onSearchChange:p,onMenuClick:()=>h(!0)}),t.jsx("main",{style:{flexGrow:1,width:"100%",display:"flex",flexDirection:"column",paddingTop:"60px"},children:t.jsx(oe,{ref:b,style:{height:"100%",paddingBottom:"80px"},data:B,initialTopMostItemIndex:B.length-1,followOutput:"smooth",itemContent:(q,k)=>t.jsx(ie,{msg:k,isMe:k.senderEmail?.toLowerCase()===v,isSelectionMode:f,isSelected:g.includes(k.id),onSelect:U,onStartSelection:$,onMediaClick:(w,P)=>O({url:w,type:P}),onProductClick:w=>i(`/marketplace/product/${w}`),playingAudioId:T,onPlayAudio:()=>{}},k.id)})}),!f&&t.jsx(ce,{onSendMessage:S,onSendAudio:()=>{},onFileSelect:()=>{},isBlocked:d,isUploading:!1}),t.jsx(de,{isOpen:L,onClose:()=>h(!1),isBlocked:d,onSearch:()=>D(!0),onSelect:()=>l(!0),onBlock:()=>{},onClear:()=>{}}),N&&t.jsx("div",{className:"fixed inset-0 z-[60] bg-black bg-opacity-95 flex items-center justify-center p-2",onClick:()=>O(null),children:t.jsx("img",{src:N.url,className:"max-w-full max-h-full object-contain"})})]})};export{he as Chat};
